<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TASK TRACKER</title>

<style>
/* ===== SIMPLE AESTHETIC THEME ===== */
:root {
  --bg: #f4f6fb;
  --card: #ffffff;
  --text: #2c2c2c;
  --muted: #666;
  --blue: #2d6cdf;
  --green: #2ecc71;
  --red: #e74c3c;
  --shadow: rgba(0,0,0,0.08);
}

body {
  font-family: "Inter", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 0;
}

header {
  width: 100%;
  background: #fff;
  box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  position: sticky;
  top: 0;
  z-index: 10;
}

.header-inner {
  max-width: 1100px;
  margin: 0 auto;
  padding: 14px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

h1 {
  font-weight: 700;
  margin: 0;
  font-size: 18px;
}

.container {
  max-width: 1100px;
  margin: 20px auto;
  padding: 0 20px;
}

.grid {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 18px;
}

.card {
  background: var(--card);
  border-radius: 16px;
  box-shadow: 0 10px 25px var(--shadow);
  padding: 18px;
}

.member {
  padding: 10px 16px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 0.9em;
  background: var(--card);
  border: 1px solid #e0e0e0;
  transition: 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.member:hover {
  transform: translateY(-2px);
}

.member.active {
  background: var(--blue);
  color: white;
  border-color: var(--blue);
}

.badge {
  font-size: 0.7em;
  padding: 2px 6px;
  border-radius: 10px;
  background: #f1c40f;
  color: #333;
  font-weight: 600;
}

#progress {
  font-size: 0.9em;
  margin-bottom: 10px;
  color: var(--muted);
}

#newTaskInput {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: 1px solid #ddd;
  box-sizing: border-box;
}

#addTaskBtn {
  width: 100%;
  padding: 12px;
  background: var(--blue);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
}

ul#taskList {
  list-style: none;
  padding: 0;
  margin-top: 15px;
}

ul#taskList li {
  padding: 14px;
  background: #f9f9f9;
  border-radius: 12px;
  margin-bottom: 10px;
  border: 1px solid #eee;
}

ul#taskList li.completed {
  background: #e9f7ef;
  color: #2e7d32;
}

.task-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.task-text {
  flex-grow: 1;
  margin-right: 10px;
}

.task-info {
  font-size: 0.75em;
  color: var(--muted);
  margin-top: 6px;
  width: 100%;
}

.status {
  font-size: 0.75em;
  font-weight: 700;
  margin-right: 10px;
}

.status.completed {
  color: var(--green);
}

.status.pending {
  color: #f1c40f;
}

.pastdue {
  color: var(--red);
  font-weight: 800;
  font-size: 0.75em;
  margin-left: 8px;
}

button.completeBtn {
  background: var(--green);
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  margin-right: 8px;
}

button.deleteBtn {
  background: var(--red);
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
}

#graphSection {
  margin-top: 18px;
}

/* Login */
#loginSection {
  display: flex;
  gap: 6px;
  align-items: center;
  justify-content: flex-end;
}

#loginSection input {
  padding: 8px;
  width: 130px;
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 12px;
}

#loginSection button {
  padding: 8px 10px;
  border-radius: 8px;
  border: none;
  background: var(--blue);
  color: white;
  cursor: pointer;
  font-size: 12px;
}

/* Popup */
#popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
}

#popupBox {
  background: #fff;
  padding: 20px;
  border-radius: 14px;
  width: 90%;
  max-width: 360px;
  text-align: center;
}

#popupBox input {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ddd;
  margin-top: 10px;
}

#popupBox button {
  margin-top: 12px;
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
}

#popupOk {
  background: var(--blue);
  color: white;
}

#popupCancel {
  background: var(--red);
  color: white;
}

/* Responsive */
@media (max-width: 900px) {
  .grid {
    grid-template-columns: 1fr;
  }
  #membersCard {
    display: none; /* hide member list on mobile */
  }
}
</style>
</head>

<body>

<header>
  <div class="header-inner">
    <h1>TASK TRACKER</h1>
    <div id="loginSection">
      <span style="font-size:12px; font-weight:700;">ADMIN</span>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div id="membersCard" class="card">
      <h2 style="margin-top:0;">Members</h2>
      <div id="members"></div>
    </div>

    <div class="card">
      <div id="taskSection">
        <h2 id="memberTitle"></h2>
        <input type="text" id="newTaskInput" placeholder="Enter new task..." />
        <button id="addTaskBtn">Add Task</button>
        <div id="progress"></div>
        <ul id="taskList"></ul>
      </div>

      <div id="graphSection" class="card" style="margin-top:18px;">
        <h2 style="margin-top:0;">Performance Graph</h2>
        <canvas id="performanceChart" width="400" height="160"></canvas>
      </div>
    </div>
  </div>
</div>

<div id="popup">
  <div id="popupBox">
    <div style="font-weight:700; font-size:16px;">Set Schedule</div>
    <input type="date" id="popupDate" />
    <button id="popupOk">Save</button>
    <button id="popupCancel">Cancel</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
 // ===== Firebase =====
 firebase.initializeApp({
   apiKey: "AIzaSyCtVN-UVUnzxbpkkMgGiNeuchhe5269qQM",
   authDomain: "teamtasktracker-d2c06.firebaseapp.com",
   projectId: "teamtasktracker-d2c06"
 });
 const db = firebase.firestore();
 const auth = firebase.auth();

 // ===== Variables =====
 let selectedMember = null;
 let data = {};
 let isMemberMode = false;
 let chart = null;
 const members = ["Meca","Johny","Jerome","Carl","Shawn","Jomar","Yvone"];

 const membersDiv = document.getElementById("members");
 const taskSection = document.getElementById("taskSection");
 const memberTitle = document.getElementById("memberTitle");
 const newTaskInput = document.getElementById("newTaskInput");
 const addTaskBtn = document.getElementById("addTaskBtn");
 const taskList = document.getElementById("taskList");
 const progressDiv = document.getElementById("progress");

 const graphSection = document.getElementById("graphSection");

 // Popup
 const popup = document.getElementById("popup");
 const popupDate = document.getElementById("popupDate");
 const popupOk = document.getElementById("popupOk");
 const popupCancel = document.getElementById("popupCancel");

 const emailInput = document.getElementById("email");
 const passInput = document.getElementById("password");
 const loginBtn = document.getElementById("loginBtn");
 const logoutBtn = document.getElementById("logoutBtn");

 // ===== Dark Mode Toggle (FIXED) =====
 // removed for simplicity (you can add back later)

 // ===== Auth Login =====
 loginBtn.onclick = () => {
   const email = emailInput.value.trim();
   const pass = passInput.value.trim();
   if (!email || !pass) return alert("Enter email & password");

   auth.signInWithEmailAndPassword(email, pass)
     .then(() => {
       emailInput.value = "";
       passInput.value = "";
     })
     .catch(err => alert(err.message));
 };

 logoutBtn.onclick = () => auth.signOut();

 // ===== Auth State =====
 auth.onAuthStateChanged(async user => {
   if (!user) {
     addTaskBtn.disabled = true;
     logoutBtn.style.display = "none";
     loginBtn.style.display = "block";
     emailInput.style.display = "inline-block";
     passInput.style.display = "inline-block";
     graphSection.style.display = "none"; // hide graph for guests
     return;
   }

   const token = await user.getIdTokenResult();
   const isAdmin = token.claims.admin;

   addTaskBtn.disabled = !isAdmin;
   graphSection.style.display = isAdmin ? "block" : "none";

   loginBtn.style.display = "none";
   emailInput.style.display = "none";
   passInput.style.display = "none";
   logoutBtn.style.display = "inline-block";
 });

 // ===== Load / Save =====
 async function loadAllTasks(){
   const snap = await db.collection("tasks").get();
   data = {};
   snap.forEach(d => data[d.id] = d.data().tasks || []);
   members.forEach(m => { if(!data[m]) data[m] = []; });
   renderMembers();
   renderGraph();
 }

 async function loadMemberTasks(member){
   const doc = await db.collection("tasks").doc(member).get();
   data = {};
   data[member] = doc.exists ? doc.data().tasks : [];
   renderTasks();
 }

 async function saveTasksForMember(member){
   await db.collection("tasks").doc(member).set({ tasks: data[member] });
   renderMembers();
   renderGraph();
 }

 // ===== Render Members (with pending count) =====
 function renderMembers(){
   membersDiv.innerHTML = "";
   members.forEach(name => {
     const pending = data[name]?.filter(t => !t.completed).length || 0;
     const div = document.createElement("div");
     div.className = "member";
     div.dataset.member = name;
     div.innerHTML = `${name}${pending ? ` <span class="badge">${pending}</span>` : ""}`;
     membersDiv.appendChild(div);
   });
 }

 // ===== Progress =====
 function renderProgress(){
   if(!selectedMember) return progressDiv.textContent="";
   const total = data[selectedMember].length;
   const completed = data[selectedMember].filter(t=>t.completed).length;
   const percent = total ? Math.round(completed/total*100) : 0;
   progressDiv.textContent = `Progress: ${completed}/${total} (${percent}%)`;
 }

 // ===== Render Tasks =====
 function renderTasks(){
   taskList.innerHTML = "";
   if(!selectedMember) return taskSection.style.display="none";
   taskSection.style.display="block";
   memberTitle.textContent = selectedMember + "'s Tasks";
   renderProgress();

   data[selectedMember].forEach((task,i)=>{
     const li = document.createElement("li");
     if(task.completed) li.classList.add("completed");

     const row = document.createElement("div");
     row.className = "task-row";

     const text = document.createElement("span");
     text.className = "task-text";

     if(task.completed){
       text.innerHTML = "✔️ " + task.text;
     } else {
       text.textContent = task.text;
     }

     row.appendChild(text);

     const info = document.createElement("div");
     info.className = "task-info";
     const created = task.createdAt ? new Date(task.createdAt).toLocaleString() : "No timestamp";

     let dueText = "No due date";
     let dueColor = "#666";
     let overdueLabel = "";

     if (task.dueDate) {
       const dueDateObj = new Date(task.dueDate);
       const today = new Date();
       today.setHours(0,0,0,0);

       dueText = dueDateObj.toLocaleDateString();

       if (!task.completed && dueDateObj < today) {
         dueColor = "#e74c3c";
         overdueLabel = "PAST DUE";
       }
     }

     info.textContent = `Created: ${created} • Due: ${dueText}`;
     info.style.color = dueColor;
     row.appendChild(info);

     const status = document.createElement("span");
     status.className = "status " + (task.completed ? "completed" : "pending");
     status.textContent = task.completed ? "COMPLETED" : "PENDING";
     row.appendChild(status);

     if(overdueLabel){
       const pastDue = document.createElement("span");
       pastDue.className = "pastdue";
       pastDue.textContent = overdueLabel;
       row.appendChild(pastDue);
     }

     if(!task.completed){
       const completeBtn = document.createElement("button");
       completeBtn.className="completeBtn";
       completeBtn.textContent="Complete";
       completeBtn.onclick = async ()=>{
         task.completed = true;
         await saveTasksForMember(selectedMember);
         renderTasks();
         confetti();
       };
       row.appendChild(completeBtn);
     }

     const deleteBtn = document.createElement("button");
     deleteBtn.className="deleteBtn";
     deleteBtn.textContent="Remove";
     deleteBtn.onclick = async ()=>{
       const user = auth.currentUser;
       if (!user) return alert("Admin only");

       const token = await user.getIdTokenResult();
       if (!token.claims.admin) return alert("Admin only");

       data[selectedMember].splice(i,1);
       await saveTasksForMember(selectedMember);
       renderTasks();
     };

     row.appendChild(deleteBtn);
     li.appendChild(row);
     taskList.appendChild(li);
   });
 }

 // ===== Add Task =====
 addTaskBtn.onclick = async ()=>{
   const user = auth.currentUser;
   if (!user) return alert("Admin only");

   const token = await user.getIdTokenResult();
   if (!token.claims.admin) return alert("Admin only");

   if(!newTaskInput.value.trim()) return;

   popup.style.display = "flex";
 };

 // ===== Popup actions =====
 popupOk.onclick = async () => {
   const dueDate = popupDate.value;

   data[selectedMember].push({
     text: newTaskInput.value,
     completed: false,
     createdAt: Date.now(),
     dueDate: dueDate
   });

   newTaskInput.value = "";
   popupDate.value = "";
   popup.style.display = "none";

   await saveTasksForMember(selectedMember);
   renderTasks();
 };

 popupCancel.onclick = () => {
   popup.style.display = "none";
 };

 // ===== Select Member =====
 membersDiv.onclick = async e=>{
   if(!e.target.closest(".member")) return;
   selectedMember = e.target.closest(".member").dataset.member;

   // MEMBER MODE
   isMemberMode = true;
   document.getElementById("membersCard").style.display = "none";
   graphSection.style.display = "none";

   await loadMemberTasks(selectedMember);
 };

 // ===== Graph =====
 function renderGraph(){
   if(chart) chart.destroy();

   const labels = members;
   const completedData = labels.map(name => (data[name] || []).filter(t => t.completed).length);
   const totalData = labels.map(name => (data[name] || []).length);

   const ctx = document.getElementById('performanceChart').getContext('2d');
   chart = new Chart(ctx, {
     type: 'bar',
     data: {
       labels,
       datasets: [
         {
           label: 'Completed',
           data: completedData,
           backgroundColor: 'rgba(46, 204, 113, 0.8)',
           borderRadius: 10
         },
         {
           label: 'Total',
           data: totalData,
           backgroundColor: 'rgba(45, 108, 223, 0.6)',
           borderRadius: 10
         }
       ]
     },
     options: {
       responsive: true,
       plugins: {
         legend: { display: true }
       }
     }
   });
 }

 // ===== Initial Load =====
 window.onload = loadAllTasks;
</script>

</body>
</html>
